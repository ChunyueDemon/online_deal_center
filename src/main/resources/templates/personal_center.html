<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<link rel="stylesheet" type="text/css" href="res/static/css/main.css">
	<link rel="stylesheet" type="text/css" href="res/layui/css/layui.css">
	<script type="text/javascript" src="res/layui/layui.js"></script>
	<script type="text/javascript" src="res/static/js/jquery.min.js"></script>
	<script type="text/javascript" src="res/static/js/cityJson.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
</head>
<body>

	<ul class="layui-nav">
		<li class="layui-nav-item">
			<a href="index.html">首页</a>
		</li>
		<li class="layui-nav-item">
			<a href="shopcart.html">购物车<span class="layui-badge-dot"></span></a>
		</li>
		<li class="layui-nav-item" lay-unselect="">
			<a href="javascript:;"><img src="a.jpg" class="layui-nav-img">我</a>
			<dl class="layui-nav-child">
				<dd><a href="personal_center.html">个人中心</a></dd>
				<dd><a href="login.html">登陆</a></dd>
				<dd><a href="logout">退出</a></dd>
			</dl>
		</li>
	</ul>
	<div class="header">
		<div class="headerLayout w1200">
			<div class="headerCon">
				<h1 class="mallLogo">
					<a href="#" title="母婴商城">
						<img src="res/static/img/logo.png">
					</a>
				</h1>

			</div>
		</div>
	</div>
	<div class="layui-tab" style="height: 100%;">
		<ul class="layui-tab-title">
			<li class="layui-this">账号管理</li>
			<li>安全设置</li>
			<li>个人资料</li>
			<li>收货地址</li>
			<li>订单管理</li>
		</ul>
		<div class="layui-tab-content">
			<div class="layui-tab-item layui-show">
				<h2 class="layui-colla-title">您的基础信息</h2>
				<a >用户名&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp18223990844</a>
				<br>
				<a >邮箱&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp18223990844&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</a><a ><i class="layui-icon">&#xe642;</i>修改邮箱</a>
			</div>
			<div class="layui-tab-item">内容2</div>
			<div class="layui-tab-item">内容3</div>
			<div class="layui-tab-item">
				<h2 class="layui-colla-title">收货地址</h2>
				<form  action="addAddress" method="post" id="form1">
					<input type="hidden" id="provinceName" name="province">
					<input type="hidden" id="cityName" name="city">
					<input type="hidden" id="countyName" name="county">
					<div class="layui-form-item">
						<label class="layui-form-label">收货地址</label>
						<div class="layui-input-inline">
							<select id="province"  onchange="doProvAndCityRelation();" lay-verify="required" class="layui-select"  style="width:200px;">
								<option id="choosePro"value="-1">请选择您所在省份</option>
							</select>
						</div>
						<div class="layui-form-mid layui-word-aux">省</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">收货地址</label>
						<div class="layui-input-inline">
							<select  lay-verify="required" id="citys" lay-verify="required" onchange="doCityAndCountyRelation();" class="layui-select"  style="width:200px;">
								<option value="-1" id='chooseCity'>请选择市</option>
							</select>
						</div>
						<div class="layui-form-mid layui-word-aux">市</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">收货地址</label>
						<div class="layui-input-inline">
							<select  lay-verify="required" id="county" lay-verify="required" class="layui-select"  style="width:200px;" onchange="getAddress()">
								<option value="-1" id='chooseCounty'>请选择县</option>
							</select>
						</div>
						<div class="layui-form-mid layui-word-aux">县</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">收货人详细地址</label>
						<div class="layui-input-inline">
							<textarea type="text" name="addressDetail" id="addressDetail"   placeholder="请输入详细地址信息，如道路、小区、门牌号等" autocomplete="off" class="layui-textarea"></textarea>
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">收货人姓名</label>
						<div class="layui-input-inline">
							<input type="text" name="name" id="name"   placeholder="请输入收货人姓名" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">手机号码</label>
						<div class="layui-input-inline">
							<input type="tel" name="tel" id="tel"  lay-verify="required|phone" placeholder="请输入收货人电话" autocomplete="off" class="layui-input">
						</div>
					</div>
					<input type="hidden" id="aaaa" name="defaultAddressTag">
					<div class="layui-form-item">
						<label class="layui-form-label"></label>
						<div class="layui-input-inline">
							<input type="checkbox"  id="111"  lay-skin="primary" >设置为默认收货地址
						</div>

					</div>

					<div class="layui-form-item">
						<div class="layui-input-block">
							<button class="layui-btn" type="button" onclick="test()" >立即提交</button>
							<button type="reset" class="layui-btn layui-btn-primary">重置</button>
						</div>
					</div>
				</form>
				<h2 class="layui-colla-title" >已保存收货地址</h2>
				<table class="layui-table" >
					<colgroup>
						<col width="150">
						<col width="200">
						<col>
					</colgroup>
					<thead>
					<tr>
						<th>收货人</th>
						<th>所在地区</th>
						<th>详细地址</th>
						<th>手机号码</th>
						<th>       </th>
					</tr>
					</thead>
					<tbody id="table">
					{{#addressInfos}}
					<tr>
						<td>{{name}}</td>
						<td>{{region}}</td>
						<td>{{addressDetail}}</td>
						<td>{{tel}}</td>
						<td><a>修改</a>|<a onclick="deleteAddress('{{itemId}}')">删除</a></td>
						<td><button type="button" class="layui-btn" onclick="setDefaultAddress('{{defaultAddressTag}}','{{itemId}}')">
							{{defaultAddressTag}}
						</button></td>
					</tr>
					{{/addressInfos}}
					</tbody>
				</table>
			</div>

			<div class="layui-tab-item">内容5</div>
		</div>
	</div>
	

	<script type="text/javascript">
		

		layui.config({
    base: 'res/static/js/util/' //你存放新模块的目录，注意，不是layui的模块目录
}).use(['mm','element','layer','table'],function(){});



$(function() {
  //load city.json
  var sb = new StringBuffer();
  $.each(cityJson,
  	function(i, val) {
  		if (val.item_code.substr(2, 4) == '0000') {
  			sb.append("<option value='" + val.item_code + "'>" + val.item_name + "</option>");
  		}
  	});
  $("#choosePro").after(sb.toString());

});
 // 省值变化时 处理市
 function doProvAndCityRelation() {
 	var city = $("#citys");
 	var county = $("#county");
 	if (city.children().length > 1) {
 		city.empty();
 	}
 	if (county.children().length > 1) {
 		county.empty();
 	}
 	if ($("#chooseCity").length === 0) {
 		city.append("<option id='chooseCity' value='-1'>请选择您所在城市</option>");
 	}
 	if ($("#chooseCounty").length === 0) {
 		county.append("<option id='chooseCounty' value='-1'>请选择您所在区/县</option>");
 	}
 	var sb = new StringBuffer();
 	$.each(cityJson,
 		function(i, val) {
 			if (val.item_code.substr(0, 2) == $("#province").val().substr(0, 2) && val.item_code.substr(2, 4) != '0000' && val.item_code.substr(4, 2) == '00') {
 				sb.append("<option value='" + val.item_code + "'>" + val.item_name + "</option>");
 			}
 		});
 	$("#chooseCity").after(sb.toString());
 } 
// 市值变化时 处理区/县
function doCityAndCountyRelation() {
	var cityVal = $("#citys").val();
	var county = $("#county");
	if (county.children().length > 1) {
		county.empty();
	}
	if ($("#chooseCounty").length === 0) {
		county.append("<option id='chooseCounty' value='-1'>请选择您所在区/县</option>");
	}
	var sb = new StringBuffer();
	$.each(cityJson,
		function(i, val) {
			if (cityVal == '110100' || cityVal == "120100" || cityVal == "310100" || cityVal == "500100") {
				if (val.item_code.substr(0, 3) == cityVal.substr(0, 3) && val.item_code.substr(4, 2) != '00') {
					sb.append("<option value='" + val.item_code + "'>" + val.item_name + "</option>");
				}
			} else {
				if (val.item_code.substr(0, 4) == cityVal.substr(0, 4) && val.item_code.substr(4, 2) != '00') {
					sb.append("<option value='" + val.item_code + "'>" + val.item_name + "</option>");
				}
			}
		});
	$("#chooseCounty").after(sb.toString());

}

function StringBuffer(str) {
	var arr = [];
	str = str || "";
  var size = 0; // 存放数组大小
  arr.push(str);
  // 追加字符串
  this.append = function(str1) {
  	arr.push(str1);
  	return this;
  };
  // 返回字符串
  this.toString = function() {
  	return arr.join("");
  };
  // 清空 
  this.clear = function(key) {
  	size = 0;
  	arr = [];
  };
  // 返回数组大小 
  this.size = function() {
  	return size;
  };
  // 返回数组 
  this.toArray = function() {
  	return buffer;
  };
  // 倒序返回字符串 
  this.doReverse = function() {
  	var str = buffer.join('');
  	str = str.split('');
  	return str.reverse().join('');
  };
};
function getAddress(){
	var provinceCode=document.getElementById("province").value;
		var provinceName='';
		var cityCode=document.getElementById("citys").value;
		var cityName='';
		var countyCode=document.getElementById("county").value;
		var countyName='';
		var sb = new StringBuffer();
	$.each(cityJson,
		function(i, val) {
			if (val.item_code == provinceCode) 
				provinceName=val.item_name;
  			if(val.item_code == cityCode)
  				cityName=val.item_name;
  			if(val.item_code==countyCode)
  				countyName=val.item_name;
		});
	document.getElementById("provinceName").value=provinceName;
	document.getElementById("cityName").value=cityName;
	document.getElementById("countyName").value=countyName;
};
function test() {
    if ($('#province').val()=='-1'){
        layer.msg('省份未选择',{icon: 5});
        return;
    }

    if($('#citys').val()=='-1'){
        layer.msg('城市未选择',{icon: 5});
        return;
	}

    if($('#county').val()=='-1'){
        layer.msg('县未选择',{icon: 5});
        return;
	}

    if($('#name').val()==''){
        layer.msg('收货人不能为空',{icon:5});
		return;
    }
    if($('#tel').val()==''){
        layer.msg('电话号码不能为空',{icon:5});
        return;
    }
    if(!isPhoneNumber($('#tel').val())){
        layer.msg("电话号码格式不正确",{icon:5});
        return;
    }
    if(document.getElementById("111").checked)
        document.getElementById("aaaa").value="默认地址";
    else
        document.getElementById("aaaa").value="设为默认";
    $.get(
        "addAddress",
        {province:$('#provinceName').val(),city:$('#cityName').val(),county:$('#countyName').val(),addressDetail:$('#addressDetail').val(),name:$('#name').val(),tel:$('#tel').val(),defaultAddressTag:$('#aaaa').val()},
        function(response) {
            var obj = eval('(' + response + ')');
            var str='';
            for (i=0;i<obj.length;i++){
                str=str+'<tr>\n' +
                    '\t\t\t\t\t\t\t<td>'+obj[i].name+'</td>\n' +
                    '\t\t\t\t\t\t\t<td>'+obj[i].region+'</td>\n' +
                    '\t\t\t\t\t\t\t<td>'+obj[i].addressDetail+'</td>\n' +
                    '\t\t\t\t\t\t\t<td>'+obj[i].tel+'</td>\n' +
                    '\t\t\t\t\t\t\t<td><a>修改</a>|<a onclick="deleteAddress('+obj[i].itemId+')">删除</a></td>\n' +
                    '\t\t\t\t\t\t\t<td><button type="button" class="layui-btn" onclick="setDefaultAddress(\''+obj[i].defaultAddressTag+'\',\''+obj[i].itemId+'\')">\n' +
                    '\t\t\t\t\t\t\t\t'+obj[i].defaultAddressTag+'\n' +
                    '\t\t\t\t\t\t\t</button></td>\n' +
                    '\t\t\t\t\t\t</tr>';
            }
            tbody=document.all.item("table");
            tbody.parentNode.outerHTML=tbody.parentNode.outerHTML.replace(tbody.innerHTML,str);
            layer.msg('添加成功',{icon:6});
        },'text')

};
/**判断是否是手机号**/
function isPhoneNumber(tel) {
	var reg =/^0?1[3|4|5|6|7|8][0-9]\d{8}$/;
	return reg.test(tel);
};
function setDefaultAddress(tag,itemId) {
    layer.open({
        content: '确认将此设置为默认地址吗？'
        ,btn: ['确认', '取消']
        ,yes: function(index, layero){
            //按钮【按钮一】的回调
            if(tag=='设为默认'){
                $.get(
                    "setDefaultAddress",
                    {itemId:itemId},
                    function(response) {
                        var obj = eval('(' + response + ')');
                        var str='';
                        for (i=0;i<obj.length;i++){
                            str=str+'<tr>\n' +
                                '\t\t\t\t\t\t\t<td>'+obj[i].name+'</td>\n' +
                                '\t\t\t\t\t\t\t<td>'+obj[i].region+'</td>\n' +
                                '\t\t\t\t\t\t\t<td>'+obj[i].addressDetail+'</td>\n' +
                                '\t\t\t\t\t\t\t<td>'+obj[i].tel+'</td>\n' +
                                '\t\t\t\t\t\t\t<td><a>修改</a>|<a onclick="deleteAddress(\''+obj[i].itemId+'\')">删除</a></td>\n' +
								'\t\t\t\t\t\t\t<td><button type="button" class="layui-btn" onclick="setDefaultAddress(\''+obj[i].defaultAddressTag+'\',\''+obj[i].itemId+'\')">\n' +
                                '\t\t\t\t\t\t\t\t'+obj[i].defaultAddressTag+'\n' +
                                '\t\t\t\t\t\t\t</button></td>\n' +
                                '\t\t\t\t\t\t</tr>';
						}
                        tbody=document.all.item("table");
                        tbody.parentNode.outerHTML   =   tbody.parentNode.outerHTML.replace(tbody.innerHTML,str);
                    },'text');
			}
            layer.closeAll('dialog');
        }
        ,btn2: function(index, layero){
            //按钮【按钮二】的回调

            //return false 开启该代码可禁止点击该按钮关闭
        }
        ,cancel: function(){
            //右上角关闭回调
            //return false 开启该代码可禁止点击该按钮关闭
        }
    });
};
function deleteAddress(itemId) {
    layer.open({
        content: '确认删除此地址吗？'
        ,btn: ['确认', '取消']
        ,yes: function(index, layero){
            //按钮【按钮一】的回调
                $.get(
                    "deleteAddress",
                    {itemId:itemId},
                    function(response) {
                        var obj = eval('(' + response + ')');
                        var str='';
                        for (i=0;i<obj.length;i++){
                            str=str+'<tr>\n' +
                                '\t\t\t\t\t\t\t<td>'+obj[i].name+'</td>\n' +
                                '\t\t\t\t\t\t\t<td>'+obj[i].region+'</td>\n' +
                                '\t\t\t\t\t\t\t<td>'+obj[i].addressDetail+'</td>\n' +
                                '\t\t\t\t\t\t\t<td>'+obj[i].tel+'</td>\n' +
                                '\t\t\t\t\t\t\t<td><a>修改</a>|<a onclick="deleteAddress(\''+obj[i].itemId+'\')">删除</a></td>\n' +
                                '\t\t\t\t\t\t\t<td><button type="button" class="layui-btn" onclick="setDefaultAddress(\''+obj[i].defaultAddressTag+'\',\''+obj[i].itemId+'\')">\n' +
                                '\t\t\t\t\t\t\t\t'+obj[i].defaultAddressTag+'\n' +
                                '\t\t\t\t\t\t\t</button></td>\n' +
                                '\t\t\t\t\t\t</tr>';
                        }
                        tbody=document.all.item("table");
                        tbody.parentNode.outerHTML   =   tbody.parentNode.outerHTML.replace(tbody.innerHTML,str);
                        layer.msg('删除地址成功',{icon:6});
                    },'text');
                layer.closeAll('dialog');
        }
        ,btn2: function(index, layero){
            //按钮【按钮二】的回调
            //return false 开启该代码可禁止点击该按钮关闭
        }
        ,cancel: function(){
            //右上角关闭回调
            //return false 开启该代码可禁止点击该按钮关闭
        }
    });

};
</script>
</body>
</html>